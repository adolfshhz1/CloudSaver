name: Docker Image CI/CD
on:
  push:
    branches: ["main"] # 添加了对 main 分支的推送触发
    tags: ["v*.*.*"] # 支持标签触发（如 v1.0.0）
  workflow_dispatch: # 添加手动触发
jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # 必须授权以推送镜像
    env:
      REPO_NAME: ${{ github.repository }}
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      IMAGE_NAME: cloudsaver
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置小写镜像名称和版本
        run: |
          # 获取仓库名称并转换为小写，用于 GHCR
          LOWER_NAME=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "LOWER_NAME=$LOWER_NAME" >> $GITHUB_ENV

          # 初始化 VERSION 变量
          VERSION=""

          # 判断触发事件类型来设置版本号
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/v* ]]; then
            # 如果是标签推送，从标签中提取版本号
            VERSION="${GITHUB_REF#refs/tags/v}"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # 如果是手动触发，我们可能需要一个默认的版本或者允许用户输入
            # 暂时使用一个默认值，例如 'manual' 或者 'latest'
            # 更好的做法是允许手动触发时输入版本号，但这里先用一个固定值
            VERSION="manual-${{ github.run_number }}" # 使用运行号作为手动触发的版本
          else
            # 对于其他非标签推送，例如推送到分支，可以使用 commit SHA 或者分支名
            # 为了避免 invalid reference format，我们不能直接使用 refs/heads/main
            # 可以使用分支名，但需要清理掉斜杠
            BRANCH_NAME=$(echo "${{ github.ref_name }}" | sed 's/[^a-zA-Z0-9._-]/-/g') # 替换非法字符为横杠
            VERSION="${BRANCH_NAME}-${{ github.sha_short }}" # 使用分支名和短SHA
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Generated VERSION: $VERSION" # 打印出来方便调试

      - name: 登录到 GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 登录到 Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 设置 QEMU 支持多架构
        uses: docker/setup-qemu-action@v2

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: 构建并推送 Docker 镜像
        uses: docker/build-push-action@v4
        with:
          context: .
          platforms: linux/amd64,linux/arm64 # 指定架构：x86_64 和 ARM64
          push: true
          tags: |
            ghcr.io/${{ env.LOWER_NAME }}:latest
            ghcr.io/${{ env.LOWER_NAME }}:${{ env.VERSION }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}
